# 安全基础结构

Contoso Ltd. 最近收购了 Tailwind Traders，后者仍使用本地文件服务器进行存储。 作为 Contoso Ltd. 的网络安全架构师，你需要评估使用现有云环境保护这些文件服务器安全的解决方案。 Tailwind Traders 为你提供了可用于实现 POC 的测试服务器（实验室 VM 2）。 在本练习中，使用 Azure Arc 设置服务器并将其集成到云基础结构和安全环境中，并将服务器日志发送到 Defender for Cloud。

## 第 1 部分：设计解决方案（必需）

在此任务中，你将设计概念以保护云基础结构内本地环境的安全。

### 设计方法

初始步骤包括基于所描述的场景分析要求，理解目标并定义要求。

根据提供的用例，可以概述以下要求：

- 在订阅上启用 Defender for Cloud
- 需要保护本地服务器安全
- 应存储日志，以便 Contoso 的 SIEM 解决方案可以处理这些日志
- 评估部署资源的符合性状态

第二步，检查 Contoso Ltd. 的现有环境。 Defender for Cloud 识别改进配置和部署的步骤，从而提供有关保护云和本地资源安全的建议。 通过主动监视工作负载，它可以增强整体安全状况，并减少威胁风险。

### 建议的解决方案

|要求|解决方案|操作计划|
|----|----|----|
|在订阅上启用 Defender for Cloud| Defender for Cloud | 在 Defender for Cloud 中激活 Defender 计划 |
|需要保护本地服务器安全 | Azure Arc | 将本地服务器载入云环境 |
|需要存储日志，以便 Contoso 的 SIEM 解决方案可以处理这些日志 |Defender for Cloud、DataCollectionRules、AzureMonitoring Agent、Log Analytics 工作区 | 创建数据收集规则以从 Contoso 的本地服务器收集日志 |
|评估部署资源的符合性状态 | Defender for Cloud 安全策略| 启用 NIST SP 800-53 Rev.5 合规性并评估合规性状态。|

## 第 2 部分：实施解决方案（可选）

### 任务 1：创建 Log Analytics 工作区

在此任务中，你将创建 Log Analytics 工作区，用于存储从不同资源接收的数据。

1. 使用 **lon-sc1\admin** 帐户登录到客户端 1 VM (LON-SC1)。 密码应由实验室托管提供程序提供。
1. 打开 **Microsoft Edge**，选择地址栏，导航到 **`https://portal.azure.com`** 并以 **User1-*******@LODSUATMCA.onmicrosoft.com** 用户身份（其中 ****** 是实验室托管提供商提供的唯一租户 ID）登录到 Azure 门户。 用户的密码应由实验室托管提供程序提供。
1. 在“保持登录?”对话框上，选中“不再显示此内容”复选框，然后选择“**否**”。
1. 选择底部的“从不”关闭密码保存对话框，以便不在浏览器中保存默认的全局管理员凭据。
1. 取消“欢迎使用 Microsoft Azure”的屏幕。
1. 选择“**创建资源**”并搜索“**Log Analytics 工作区**”
1. 找到 **“Log Analytics 工作区”图块**，选择“**创建**”。
1. 在“创建 Log Analytics 工作区”站点上，新建“**资源组**”，并将其命名为 **`ContosoRG`**。
1. 在实例详细信息中，输入名称 **`ContosoLA`**，区域选择“**美国东部**”。
1. 选择“**查看并创建**”
1. 选择“创建”以开始部署。****

已成功创建 Log Analytics 工作区。

### 任务 2：启用 Defender for Cloud

在 Defender for Cloud 可以对资产应用保护之前，必须为要保护的资源类型启用 Defender 计划。

1. 你仍应登录到 Azure 门户 **https://portal.azure.com**。
1. 搜索“**Microsoft Defender for Cloud**”并将其打开。
1. 在左侧菜单窗格中，展开“**管理**”并选择“**环境设置**”。
1. 选择“**展开全部**”，然后选择你的订阅。
1. 如果订阅显示为“**未注册**”，则重新加载页面。
1. 选择订阅旁边的省略号 (...)，然后选择“**编辑设置**”。
1. 在“**云工作负载保护**”下，将“**服务器**”计划的滑块置于右侧“**打开**”位置。
1. 选择页面顶部的“**保存**”。

启用“服务器计划”时，可以看到 Defender for Cloud 支持更多资源类型。

### 任务 3：在 Azure Arc 中启用本地服务器

Azure Arc 是必需的，以便可用于将数据发送到 Defender for Cloud 所用的 Log Analytics 工作区。

1. 切换到 VM **LON-SC2** 并登录到Azure 门户 **`https://portal.azure.com`**。
1. 搜索并打开 **`Azure Arc`**。
1. 在左侧导航窗格中，展开“**Azure Arc 资源**”，然后选择“**计算机**”。
1. 选择“**添加/创建**” > “**添加计算机**”。
1. 在“添加单一服务器”下，选择“**生成脚本**”。
1. 在“资源组”字段中，使用下拉菜单选择 **ContosoRG**。
1. 在“区域”字段中，使用下拉菜单选择“**美国东部**”。
1. 选择“**下载并运行脚本**”。
1. 选择“**下载**”并在第二个实验室客户端 **LON-SC2** 上运行脚本，以将本地服务器载入 Azure。
1. 以管理员身份运行 Windows PowerShell。 为此，请使用鼠标右键选择窗口右下角的 Windows 图标，然后选择“**Windows PowerShell(管理员)**”
1. 将执行策略设置为“无限制”。

    ```Powershell
    Set-ExecutionPolicy -ExecutionPolicy unrestricted
    ```

1. 在 PowerShell 窗口中，选择 Y
1. 运行载入脚本。 为此，选择“文件资源管理器”。 它应该会将你带到服务器 VM 的本地 C 盘上的下载文件夹。 使用鼠标右键选择文件 **OnboardingScript**，然后选择“**使用 **PowerShell 运行**”。
1. 出现身份验证弹出窗口时，请使用 Azure 门户所用的同一帐户登录。
1. 等待脚本成功完成。
1. 返回到 LON-SC1 并打开 Azure Arc。
1. 选择“**计算机**”，选择页面顶部的“**刷新**”，然后验证服务器是否已成功部署到 Azure Arc。

已成功在测试服务器上启用 Azure Arc，且数据应开始流入 Log Analytics 工作区。 可能在此过程进行一段时间之后，你才能在仪表板中看到内容。

### 任务 4：将服务器添加到 Defender for Cloud 并收集日志。

你将部署数据收集规则，以从本地服务器获取事件日志。 该规则将自动在服务器上部署监视代理，并将日志转发到之前创建的 Log Analytics 工作区。

1. 你仍应登录到 Azure 门户 **https://portal.azure.com**。
1. 打开 Defender for Cloud。
1. 在左侧菜单窗格中，展开“**管理**”并选择“**环境设置**”。
1. 选择**全部展开**。
1. 你将看到之前创建的 Log Analytics 工作区 **ContosoLA**。  
1. 选择 **ContosoLA** 行项的省略号 (...)，然后选择“**编辑设置**”。
1. 将“**服务器**”计划右侧的滑块设置为“**开启**”。
1. 选择页面顶部的“**保存**”。
1. 使用顶部的搜索栏搜索**数据收集规则**，然后从搜索结果中选择该规则。
1. 选择**创建**。
1. - 规则名称：**`ContosoDCR`**
   - 资源组：**ContosoRG**
1. 选择“下一步: 资源”。
1. 选择“**添加资源**”。 展开资源组的范围。 检查以前载入的 Azure Arc 计算机，选择“**应用**”。
1. 选择“下一步: 收集和传递”。
1. 选择“添加数据源”。
1. 选择数据源类型“**Windows 事件日志**”。
1. 在“**配置事件日志和级别以收集：**”下，选择所有选项。
1. 选择“下一步: 目标”。
1. 选择“**添加目标**”。
   - 目标类型：**Azure Monitor 日志**
   - 帐户或命名空间：**ContosoLA**
1. 选择“添加数据源”。
1. 选择“**查看和创建**”。
1. 选择**创建**。

可能需要几个小时才能在 Defender for Cloud 中完全载入资源。 下一步是查看 Defender for Cloud 为此资源生成的建议。

### 任务 5：添加合规性标准

根据建议，可以开始保护资源安全并分配安全策略（例如 NIST SP 800-53 Rev.5），以确保 Tailwind Traders 的资源符合合规性规定。

1. 你仍应登录到 Azure 门户 **https://portal.azure.com**。
1. 打开 Defender for Cloud，展开“**管理**”并选择“**环境设置**”。
1. 选择**全部展开**。
1. 选择订阅旁边的省略号 (...)，然后选择“**编辑设置**”。
1. 在左侧导航菜单中，选择“**安全策略**”。 加载此列表可能需要一段时间。
1. 搜索 **`NIST SP 800-53 Rev. 5`**。 将“状态”滑块切换为“**打开**”。
1. 返回到 Defender for Cloud，展开“**云安全**”，然后选择“**监管合规性**”。

由于实验室环境的限制，无法查看资源以及合规性建议。 部署的资源需要一段时间才能在 Defender for Cloud 中可见。

在“合规性”仪表板中，现在可以查看仪表板中显示的任何失败评估，以了解建议的详细信息。

通过持续评估针对这些控制措施的资源，Defender for Cloud 可识别可能阻碍实现特定合规性认证的问题。 维护合规性对于保护组织的数据并确保安全云环境至关重要。
