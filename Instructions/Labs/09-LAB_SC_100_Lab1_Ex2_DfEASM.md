# 管理外部攻击面

## 练习概述

Contoso 旨在通过识别和管理其外部攻击面来增强其网络安全态势。 此攻击面包括托管在不同云提供商上的资产。 为了实现此目标，Contoso 希望将其攻击面数据与其云原生 SIEM 解决方案 Sentinel 集成。 这种集成将增强其安全监控和事件响应能力。 

## 第 1 部分：设计解决方案（必需）

在此任务中，你将设计一个概念来概述你的面向外部的资产及其攻击面。

### 设计方法

初始步骤包括基于所描述的场景分析要求，理解目标并定义要求。

根据提供的用例，可以概述以下要求：

- 需要监控和保护 Contoso 面向外部的资产
- 发现与 Contoso 关联的所有资产
- 将数据集成到 Contoso 的 SIEM 解决方案。
- 资产需要进行管理和标记

第二步，检查 Contoso Ltd. 的现有环境。 Microsoft Defender 外部攻击面管理 (EASM) 持续发现和映射数字攻击面，以提供组织在线基础结构的外部视图。 它标识暴露的资源、确定风险的优先级，并将漏洞和暴露控制扩展到防火墙之外。

### 建议的解决方案

|要求|解决方案|操作计划|
|----|----|----|
|需要监控和保护 Contoso 面向外部的资产| Defender EASM | 创建 Microsoft Defender EASM 资源|
|发现与 Contoso 关联的所有资产 | Defender EASM |在 Contoso 的资产上创建发现作业  |
|将数据集成到 Contoso 的 SIEM 解决方案 |Defender EASM、Log Analytics 工作区 | 将 Log Analytics 工作区连接到 Defender EASM |
|资产需要进行管理和标记 | Defender EASM | 管理可计费资产和标记 |


## 第 2 部分：实施解决方案（可选）

### 任务 1 - 设置 Defender EASM

在此任务中，你将创建 Defender EASM 工作区。

1. 使用 **lon-sc1\admin** 帐户登录到客户端 1 VM (LON-Sc1)。 密码应由实验室托管提供程序提供。
1. 打开 **Microsoft Edge**，选择地址栏，导航到 **`https://portal.azure.com`**，以用户 <user1-ZZZZZZZ@LODSUATMCA.onmicrosoft.com> 的身份登录到 Azure 门户。 管理员的密码应由实验室托管提供程序提供。
1. 在“保持登录?”对话框上，选中“不再显示此内容”复选框，然后选择“否”  。
1. 选择底部的“从不”关闭密码保存对话框，以便不在浏览器中保存默认的全局管理员凭据。
1. 在顶部搜索栏中搜索 **`Microsoft Defender EASM`**。
1. 选择**创建**。
1. 在“创建Microsoft Defender EASM 资源”上，选择现有资源组 **rg_eastus_soc**。
    >[!NOTE] 如果未列出 rg_eastus_soc 资源组，则需要再次创建它，因为打开新的实验室实例不会保留以前的工作。
1. 在实例详细信息中输入名称 **`EASM`**，区域选为“**美国东部**”。
1. 选择“查看 + 创建”。****
1. 选择**创建**。

你已成功创建 Defender EASM 工作区。

### 任务 2 - 创建发现

在此任务中，你将在 Contoso Ltd. 面向外部的资产上创建发现。 创建实例后，需要使用实际数据填充该实例。 因此，现在将创建发现。

1. 你仍应登录到 Azure 门户 **https://portal.azure.com**。
1. 在顶部的搜索栏中，搜索并打开 **`Microsoft Defender EASM`**。
1. 选择在上一个任务中创建的 **EASM** 工作区。
1. 在“**搜索组织**”搜索字段中搜索 **Contoso**。
1. 选择“**Contoso Ltd.**”。
1. 选择“**开始攻击面发现**”。

已成功创建 Contoso 的外部攻击面发现，并使用可操作数据填充 EASM 实例。

### 任务 3 - 设置数据连接器和 Log Analytics 工作区

在此任务中，你将配置从 Defender EASM 到将用于 Sentinel 的 Log Analytics 工作区的数据连接。 可以在 Log Analytics 中使用 Defender EASM 资产或见解信息，以使用其他安全数据扩充现有工作流。

1. 你仍应登录到 Azure 门户 **https://portal.azure.com**。
1. 在顶部搜索栏中搜索 **`Log Analytics Workspaces`**。
1. 从上一练习中选择你的 **law-sentinel** 工作区。
    >[!NOTE] 如果未列出 law-sentinel 工作区，则需要再次创建它，因为打开新的实验室实例不会保留以前的工作。 请参阅安全运营中心练习，第 2 部分，任务 1。
1. 将页面保留原样，然后打开另一个选项卡并登录到 Azure 门户 **`https://portal.azure.com`**。
1. 在顶部的搜索栏中，搜索并打开 **`Microsoft Defender EASM`**。
1. 选择 **EASM** 工作区。
1. 在左侧导航窗格中，展开“**消息**”，然后选择“**数据连接**”。
1. 在 Log Analytics 下，选择“**添加连接**”。
1. 将其命名为 **law-sentinel**
1. 切换到上一个选项卡，其中应打开 Log Analytics 工作区。
1. 展开“**Log Analytics 代理说明**”。
1. 将**工作区 ID** 复制到“添加数据连接”窗口的相应字段中。
1. 将 ** **主密钥** 复制到“添加数据连接”窗口的 API 密钥字段中。
1. 在“内容”中选择“**全部**”。
1. 在“频率”中选择“**每日**”。
1. 选择 **添加** 。
1. “数据连接”页的 Log Analytics 卡现在应显示“已连接 (1)”下列出的 law-sentinel。

创建连接后，在 Log Analytics 工作区中创建自定义日志表。 在 Sentinel 中，此数据随后可用于创建或扩充安全事件、构建调查 playbook、训练机器学习算法或触发修正操作。

你可以成功设置 Defender EASM 与 Log Analytics 工作区之间的连接。

### 任务 4 - 查看仪表板和标签资产

在此任务中，你将查看 Defender EASM 安全状况并获取有关发现的信息。

1. 你仍应登录到 Azure 门户 **https://portal.azure.com**。
1. 在顶部的搜索栏中，搜索并打开 **`Microsoft Defender EASM`**。
1. 选择 **EASM** 工作区。
1. 在左侧导航窗格中，展开“**仪表板**”，然后选择“**攻击面摘要**”。 “攻击面摘要”仪表板提供攻击面的受影响核心资产的关键见解和简要概述。
1. 查看**攻击面摘要**仪表板。
1. 从左侧导航窗格中，选择“**安全状况”**。
1. 查看开放漏洞的不同类别。
1. 在“**开放端口**”类别下，选择 **“Web 服务器**”。
1. 选择找到的 IP 地址 **34.223.124.45**。
1. 你决定标记资产以供进一步调查。
1. 选择“**修改资产**”。
1. 选择“**创建新标签**”。
1. 将其命名为“**打开端口**”，然后选择“**添加**”。
1. 在“**标签**”字段中分配新创建的标签。
1. 选择“更新”****。

你已成功查看安全态势，并标记了资产以供进一步调查。

### 任务 5 - 管理资产

在此任务中，你将管理和分类已发现的资产。

1. 你仍应登录到 Azure 门户 **https://portal.azure.com**。
1. 在顶部的搜索栏中，搜索并打开 **`Microsoft Defender EASM`**。
1. 选择 **EASM** 工作区。
1. 在左侧导航窗格中，展开“**常规**”并选择“**库存**”。
1. 在“EASM | 库存”页，选中“搜索”选项卡（带下划线）。 在搜索字段中，使用下拉菜单选择“**标签**”
1. 在下面的下拉菜单中，选择最近创建的标签，**打开端口**。
1. 选择“搜索”。****
1. 打开找到的资产 **34.223.124.45**。
1. 选择“**Web 组件**”选项卡。
1. 你发现此资产托管在 Amazon 上，某些组件上还有公开的 CVE，但正如“**最新动态**”和“**上次上线**”列的信息所示，它们并未处于活动状态。 这些源自早期的发现运行。
由于该资产由第三方托管，但仍属于你的攻击面，因此你根据其在组织中的角色对其进行分类。
1. 选择“**修改资产**”。
1. 在“修改资产”窗口中，使用下拉列表的“**状态**”字段选择“**依赖项**”。
1. 选择“更新”****。
    >[!NOTE]在本案例中，你选择“依赖关系”，因为该资产是第三方拥有的基础设施，但由于它直接为你拥有的资产运行提供支持，因此是你攻击面的一部分。
1. 通过选择右上角的 **X** 返回“库存”，然后创建新的搜索。
1. 将搜索查询修改为 **Web 组件名称 - 包含 - Amazon**。
1. 选择“搜索”。****
1. 选择所有资产。
1. 选择“**修改资产**”。
1. 选择“状态”的“**依赖项**”，然后选择“**更新**”。

仅当“状态”设置为“**已批准库存**”时，资产才会在仪表板图表中显示，并每天进行扫描。 因此，查看新发现的资产并相应地更改其状态非常重要。

在本练习中，你设置了 Defender EASM，创建了 Contoso 面向外部环境的发现，更深入地了解了资产及其配置情况，并对资产进行了管理，以便仪表板仅包含 Contoso 直接负责的数据。
