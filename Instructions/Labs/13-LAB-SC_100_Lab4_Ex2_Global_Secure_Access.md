# 全局安全访问

设置监控服务器后，需要使用全球安全访问 (GSA) 建立到文件服务器的安全网络。 你希望确保在可以将这些文件服务器迁移到安全的云存储之前，对这些计算机的访问是安全的，尤其是在 Tailwind Traders 将本地服务器引入公司 IT 基础结构时。 你决定不重新设计 Tailwind Traders 的 VPN 基础结构，以允许员工访问服务器。 

要建立安全网络连接，首先要创建 Azure 应用代理并将客户端注册到 Entra ID，然后再创建连接器。 然后，配置访问策略并安装 GSA 客户端。 最后，测试 GSA 连接，确保一切正常运行。

## 第 1 部分：设计解决方案（必需）

在此任务中，你将保护对本地环境的远程访问安全。

### 设计方法

初始步骤包括基于所描述的场景分析要求，理解目标并定义要求。

根据提供的用例，可以概述以下要求：

- 为本地服务器启用安全远程访问
- 与现有基础结构集成
- 请勿使用已弃用的 Tailwind Traders 基础结构

全局安全访问与 Contoso Ltd. 的现有云基础结构集成，并允许员工安全地远程访问 Tailwind Traders 本地基础结构中的本地服务器。 查看 GSA 并考虑与其他策略在远程访问服务方面的差异。

### 建议的解决方案

|要求|解决方案|操作计划|
|----|----|----|
|为本地服务器启用安全远程访问| EntraID 全局安全访问 | 启用全球安全访问  |
|与现有基础结构集成 | 应用程序代理 | 在 Contoso 的 Fileserver 上部署应用程序代理 |

## 第 2 部分：实施解决方案（可选）

### 任务 1：激活全局安全访问

第一步是在租户中激活全局安全访问。

1. 以本地**管理员**身份登录到 **LON-SC1** VM（客户端终结点）。密码应由实验室托管提供商提供。
1. 打开 **Microsoft Edge**，选择地址栏，导航到 **https://entra.microsoft.com** 并以 **MOD Administrator**admin@WWLxZZZZZZ.onmicrosoft.com（其中 ZZZZZZ 是实验室托管提供商提供的唯一租户 ID）登录到 Entra 门户。 用户的密码应由实验室托管提供程序提供。
1. 在“**保持登录?**”对话框上，选中“**不再显示此内容**”复选框，然后选择“**否**”。
1. 在“**保存密码**”对话框中，选择“**以后再说**”。
1. 如果出现“**登录到 Microsoft Edge**”对话框，选择“**不，谢谢**”按钮。
1. 如果在屏幕右上方看到显示“**管理多重身份验证**”的信息框，请通过选择 **X** 将其关闭。
1. 在左侧导航窗格中展开“**全局安全访问**”，然后选择“**仪表板**”。
1. 在“**在租户中激活全局安全访问**”下，选择“**激活**”。

已成功激活全局安全访问。

### 任务 2：启用 TLS 并安装专用网络连接器

专用网络连接器是一种轻量级代理，安装在本地环境中的 Windows Server 上，可以访问后端资源和应用程序，并用于实现与全球安全访问服务的连接。  在安装专用网络连接器之前，必须为安装了连接器的 Windows Server 启用 TLS 1.2。

1. 使用本地**管理员**帐户登录到服务器 VM **LON-SC2**。 密码应由实验室托管提供程序提供。
1. 登录到 VM 时，服务器管理器将打开。  可以最小化此窗口。
1. 在服务器上安装专用网络连接器之前，需要启用 TLS 1.2。  你可以采用几种方法来完成此操作。 在本练习中，你将复制命令以将注册表项设置为文件，然后运行该文件。

    1. 打开 **Microsoft Edge**。
    1. 在浏览器标签页上，输入 URL：**`https://learn.microsoft.com/en-us/entra/global-secure-access/how-to-configure-connectors`**，然后按键盘上的 Enter 键打开产品文档。
    1. 向下滚动到“**传输层安全性 (TLS) 要求**”部分，并从“**设置注册表项**”下列出的代码框中，选择“**复制**”
    1. 在 VM 中，打开记事本。 在任务栏的搜索字段中，键入“**`Notepad`**”，然后选择“**记事本**”以打开该应用程序。
    1. 使用 **Ctrl+V** 将代码粘贴到记事本中。  请勿更改粘贴代码中的任何内容。 需要第一行代码。
    1. 从记事本中选择“**文件**”，然后选择“**另存为**”。 
    1. 在“**保存类型**”字段中，从下拉列表中选择“**所有文件**”，在“**文件名**”字段中输入**`EnableTLS.reg`**，然后选择“**保存**”。  请务必使用 .reg 扩展名保存文件。 记下文档的保存位置，然后关闭记事本。
    1. 在任务栏中，打开“**文件资源管理器**”并导航到保存文件的文件夹（默认位置为“此电脑”>“文档”）。
    1. 双击文件名“**Enable-TLS**”以运行此文件。  由于要更改注册表文件，系统会询问“**是否确定要继续？**”  选择“**是**”，然后选择“**确定**”。  
    1. 由于更新了注册表，因此你需要重启服务器。 从服务器 VM 的任务栏中，选择 **Windows 图标**，选择“**电源**”，选择“**重启**”，然后选择“**继续**”。
    1. 重启后，以本地**管理员**身份重新登录到服务器 VM。
    1. 最小化或关闭服务器管理器。
1. 打开 **Microsoft Edge**，选择地址栏，导航到 **`https://entra.microsoft.com`** 并以 **MOD Administrator **admin@WWLxZZZZZZ.onmicrosoft.com 登录到 Entra 门户（其中 ZZZZZZ 是实验室托管服务提供商提供的唯一租户 ID）。 用户的密码应由实验室托管提供程序提供。
1. 像上一个任务中一样关闭对话框。
1. 在左侧导航面板中，展开“**全球安全访问**”，展开“**连接**”，然后选择“**连接器**”。
1. 在“专用网络连接器”页顶部，选择“**下载连接器服务**”。
1. 查看信息，然后选择“**接受条款并下载**”。
1. 从页面右上角的下载窗口中，在下载完成后选择“**打开文件**”。  如果在你能够选择“打开文件”之前下载窗口已关闭，请从任务栏中选择“**文件资源管理器**”，转到“**下载**”文件夹，然后运行文件“**MicrosoftEntraPrivateNetworkConnectorInstaller**”。
1. 选中“**我同意许可证的条款和条件**”旁边的框，然后选择“**安装**”。
1. 在安装过程中，必须使用 MOD 管理员的用户名和密码登录。 可能需要几分钟时间才能完成安装。
1. 安装完成后，**关闭**安装窗口并刷新浏览器页面。  你应该会看到连接器已列出且处于活动状态。
1. 在 Windows 任务栏的搜索栏中输入 **`cmd`**，然后选择“**命令提示符**”。 
1. 在“管理员: 命令提示符”窗口中，运行 **`ipconfig`** 命令，记下服务器的专用 IP 地址，然后关闭命令提示符窗口。

已成功在本地服务器上安装专用网络连接器。

### 任务 3：在文件服务器上创建文件夹

在此任务中，你将在要通过 GSA 访问的本地文件服务器上创建 SMB 共享。

1. 你仍应登录到 LON-SC2。
1. 在任务栏中，打开“**文件资源管理器**”，导航到 C:盘，并创建名为“**共享**”的文件夹。
1. 使用鼠标右键，选择“**共享**”文件夹，然后选择“**属性**”。
1. 在“共享属性”窗口中，选择“**共享**”选项卡。
1. 选择“**共享...**”。
1. 从下拉列表中选择“**任何人**”，然后选择“**添加**”。
1. 选择**共享**。
1. 选择“**不，将我连接的网络设为专用网络**”。
1. 选择“**完成**”，然后选择“**关闭**”。
1. 最小化或关闭文件资源管理器。

已在服务器上创建了共享文件夹。 你将通过 GSA 访问此文件夹及其内容。

### 任务 4：设置快速访问并分配用户

专用访问提供了两种方法来配置要通过服务建立隧道的专用资源。 快速访问或全局安全访问应用程序。 在本练习中，你将使用快速访问。

快速访问是要保护的主要 FQDN 和 IP 地址组。 配置快速访问时，需要新建企业应用程序，作为要保护的专用资源的容器。

为了使用户能够通过 GSA 客户端访问文件服务器的资源，需要启用“快速访问”并将其分配给测试用户。

1. 可以在此步骤中继续执行 LON-SC2。
1. 在左侧导航窗格中展开“**全局安全访问**”，展开“**应用程序**”，然后选择“**快速访问**”。 输入以下信息：
    - 名称：**`SMB to ContosoFS`**
    - 连接器组：**默认值**
1. 选择“**添加快速访问应用程序段**”并填写以下信息：
    - 目标类型：**IP 地址**
    - IP 地址：在前面步骤中记录的服务器专用 IP 地址**`192.168.2.100`**。
    - 端口：**`445`**
1. 选择“应用”。
1. 选择“保存”。 看到应用程序段的“状态”字段显示成功后，刷新浏览器页面。 刷新页面后，将转到“**快速访问 | 网络访问属性**”页。
1. 在左侧选择“**用户和组**”。
1. 选择“添加用户/组”。****
1. 选择“**未选择任何项**”
1. 在搜索字段中输入**`MOD Administrator`**，然后从搜索结果中将其选中。
1. 在页面底部，按 **SELECT**，然后选择“**分配**”。

已成功为测试用户启用快速访问。

### 任务 5：设备加入 Entra ID

要使用全局安全访问，需要将客户端终结点 LON-SC1 VM 加入Microsoft Entra ID。 否则 GSA 客户端将无法工作。

1. 切换回 **LON-SC1** VM（这是客户端终结点 VM）
1. 使用鼠标右键，选择任务栏中的 Windows 图标，然后选择“**设置**”。
1. 从左侧导航面板中选择“**帐户**”。
1. 从“帐户”页中，选择“**访问工作或学校帐户**”。
1. 要添加工作或学校帐户，请选择“**连接**”。
1. 在窗口底部，选择“**将设备加入 Microsoft Entra ID**”。
1. 使用实验室提供商提供的 **MOD 管理员**管理员凭据登录。
1. 在“**确保这是你所在组织**”窗口中，查看信息并选择“**加入**”。
1. 在“**你已完成设置**”窗口上查看信息，然后选择“**完成**”。
1. 使用 MOD 管理员帐户将设备加入 Entra ID 后，现在需要使用该帐户登录。
    1. 从任务栏中，选择“**Windows**”图标，选择“**管理员**”，然后选择“**切换用户**”。
    1. 在窗口左下角，选择“**其他用户**”，然后使用 MOD 管理员帐户登录。
    1. 设置帐户需要几分钟时间，然后会出现“**所需的更多详细信息**”窗口。 这将启动设置多重身份验证的过程。  请按照说明设置 MFA。

将终结点加入 Entra ID 后，即可设置 GSA 客户端，该客户端用于连接到使用全局安全访问保护的任何资源。

### 任务 6：激活流量转发配置文件并下载 GSA 桌面客户端

要在本地环境中启用对专用资源或应用程序的访问，需要为专用访问启用流量转发配置文件并分配用户。

还需要下载并安装全局安全访问桌面客户端。  

可以通过全局安全访问桌面客户端进行连接，将专用访问流量转发至服务。

1. 你仍应位于使用 MOD 管理员帐户登录的 **LON-SC1** 上。
1. 打开 **Microsoft Edge**。 系统会提示设置 Microsoft Edge。
1. 在 Microsoft Edge 中，导航到**`https://entra.microsoft.com`**。
1. 在左侧导航面板中，展开“**全局安全访问**”，展开“**连接**”，然后选择“**流量转发**”。  可能需要选择“**>>**”展开左侧导航面板才能查看选项。
1. 选择“**专用访问配置文件**”旁边的滑块按钮，然后选择“**确定**”。
1. 启用专用访问配置文件后，需要分配用户。
    1. 在专用访问个人资料卡片的“**用户和组分配**”下，选择“**查看**”。
    1. 选择显示“**已分配 0 个用户，0 个组**”的位置
    1. 选择“添加用户/组”。****
    1. 选择“**未选择任何项**”
    1. 在搜索栏中，输入 **`MOD Administrator`**，选择“**MOD 管理员**”，按“**选择**”，然后选择“**分配**”。
1. 在左侧导航窗格的“**连接**”下，选择“**客户端下载**”。
1. 在 Windows 10/11 下，选择“**下载客户端**”。
1. 从“下载”窗口选择“**打开文件**”。 如果在你能够选择“打开”文件之前关闭“下载”窗口，请从任务栏中选择“**文件资源管理器**”，转到“**下载**”文件夹，然后运行文件 **GlobalSecureAccessClient**。
1. 选择“**我同意许可证的条款和条件**”，然后选择“**安装**”。 在弹出的“用户帐户控制”窗口中，选择“**是**”。
1. 成功完成安装后，“**关闭**”窗口。
1. 从任务栏中，选择向上箭头以显示隐藏的图标。  在这里，你将看到“全球安全访问”客户端图标。 如果没有绿色复选标记，请右键单击图标并选择“**启用**”。 可能需要几分钟才能显示带有绿色复选标记，以表明它已连接。
1. 从任务栏中选择“**文件资源管理器**”并导航到“**此电脑**”。 选择省略号（“**...**”），然后选择“**映射网络驱动器**”。
1. 在“文件夹”字段中，输入 `\\192.168.2.100\Share`。 使用前面提到的 IP 地址，并选择“**使用不同的凭据进行连接**”。
1. 选择“完成”。
1. 若要映射网络驱动器，请使用 LON-SC2 上本地管理员帐户的凭据。  
    1. 电子邮件字段：**`Administrator`** （这可能因实验室主机而异）。
    1. 密码字段：**`Pa55w.rd`** （这可能因实验室主机而异）。
    
    >[!NOTE] 众所周知，使用本地管理员帐户不是典型场景。 由于简化了本地环境，因此在本练习中使用了它。 更现实的情况是，在更复杂的本地环境中，用户可以使用其 Entra ID 帐户访问私有资源。

1. 在转到下一个实验室之前，建议切换用户以获得最佳屏幕大小。
    1. 从任务栏中，选择 **Windows** 图标，选择"**MOD 管理员**"，然后选择“**切换用户**”。
    1. 从窗口左下角选择“**管理员**”，然后使用本地管理员帐户登录。

你已使用全局安全访问成功连接到文件服务器。
